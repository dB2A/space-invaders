<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Electronic Basstard - Space Invaders</title>
        <link rel="stylesheet" href="css/style.css">
        <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
        <script type="text/javascript" src="js/raphael-min.js"></script>
        <script type="text/javascript" src="js/space-invader.js"></script>
        <script type="text/javascript">
            $(document).ready(function () {
                var duration         = 500;
                var delayAtStart     = 500;
                var animationTypes   = ['cubic-bezier(0, 1, 1, 0)','cubic-bezier(1, 0, 0, 1)', 'linear', '<', '>', '<>', 'backIn', 'backOut', 'elastic', 'bounce'];
                var maxX             = 200;
                var maxY             = 200;
                var minX             = 0;
                var minY             = 0;
                var numSpaceInvaders = 20;
                var dieAfter         = 10;
                //
                var anims            = [];
                var svgPaths         = []
                var s                = [];
                var animationType    = animationTypes[0];
                var modeAuto         = false;
                var timer            = null;
                var randomTimeOut    = 10000;

                $('#speed').text(-1 * ((duration-1000)/10));
                $('#animation').text(animationType);
                $('#randomTimer').text(randomTimeOut / 1000 + 's');

                svgPaths.push(spaceinvaderPath);
                svgPaths.push(spaceinvader2Path);
                svgPaths.push(spaceinvader3Path);

                $(this).keydown(function (event){
                    if (event.keyCode === 72) {
                        $('#toolbar').fadeToggle('slow');
                    }

                    //arrow up
                    if (event.keyCode === 38 && duration > 0 && false === modeAuto) {
                        (duration - 100 < 0)?duration = 0:duration -= 100;
                        $('#speed').text(-1 * ((duration-1000)/10));
                        return;
                    }

                    //arrow down
                    if (event.keyCode === 40 && duration < 1000 && false === modeAuto) {
                        (duration + 100 > 1000)?duration = 1000:duration += 100;
                        $('#speed').text(-1 * ((duration-1000)/10));
                        return;
                    }

                    //+
                    if (event.keyCode === 107 && false === modeAuto) {
                        randomTimeOut += 1000;
                        $('#randomTimer').text(randomTimeOut/1000 + "s");
                        return;
                    }

                    //-
                    if (event.keyCode === 109 && false === modeAuto) {
                        (randomTimeOut - 1000 < 1000)?randomTimeOut = 1000:randomTimeOut -= 1000;
                        $('#randomTimer').text(randomTimeOut/1000 + "s");
                        return;
                    }

                    //arrow right
                    if (event.keyCode === 39 && false === modeAuto) {
                        animationType = animationTypes.shift();
                        animationTypes.push(animationType);
                        $('#animation').text(animationType);
                        return;
                    }

                    //arrow left
                    if (event.keyCode === 37 && false === modeAuto) {
                        animationType = animationTypes.pop();
                        animationTypes.unshift(animationType);
                        $('#animation').text(animationType);
                        return;
                    }

                    //a
                    if(event.keyCode === 65) {
                        if (true === modeAuto) {
                            modeAuto = false;
                            $('#auto').text('OFF');
                            $('#toolbar').toggleClass('auto');
                            clearInterval(timer);
                        } else {
                            modeAuto  = true;
                            $('#auto').text('ON');
                            $('#toolbar').toggleClass('auto');
                            timer = setInterval(function() {
                                animationType = animationTypes[random(animationTypes.length)];
                                duration      = random(1000);
                                $('#speed').text(-1 * ((duration-1000)/10));
                                $('#animation').text(animationType);
                            }, randomTimeOut);
                        }
                        return;
                    }
                });

                //east
                anims.push(function () {
                    return Raphael.animation({
                        transform: '...t'+maxX+','+minY,
                        fill: '#FF0000'
                    }, duration , animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //south
                anims.push(function () {
                    return Raphael.animation({
                        transform: '...t'+minX+','+maxY,
                        fill: '#7FFF00'
                    }, duration , animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //west
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...t-' + maxX + ',' + minY,
                        fill: '#00FFFF'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //nort
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...t'+minX+',-'+maxY,
                        fill: '#7F00FF'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //north-east
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...t'+maxX+',-'+maxY,
                        fill: '#FF00BF'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //north-west
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...t-'+maxX+',-'+maxY,
                        fill: '#003FFF'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //south-east
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...t'+maxX+','+maxY,
                        fill: '#FFBF00'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //south-west
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...t-'+maxX+','+maxY,
                        fill: '#00FF3F'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //bigger
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...s1.5',
                        fill: '#FFFFFF'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                //smaller
                anims.push(function () {
                    return Raphael.animation({
                        transform : '...s0.5',
                        fill: '#FFFFFF'
                    }, duration, animationType, function () {
                        $(this).trigger('animationEnded');
                    });
                });

                function random(max) {
                    return Math.floor(Math.random() * max);
                }

                function getNextAnim() {
                    return anims[random(anims.length)]();
                }

                $(document).bind({
                    'SVGRemoved' :
                    function (event, index) {
                        createSpaceInvader(i).trigger('animationStart', [random(500)]);
                    }
                });

                var paper = Raphael('spaceinvader', document.documentElement.clientWidth, document.documentElement.clientHeight - 5);


                for(var i=0; i<numSpaceInvaders;i++) {
                    createSpaceInvader(i).trigger('animationStart', [500 + delayAtStart * i]);
                }

                function createSpaceInvader(i) {
                    s[i] = paper.path(svgPaths[random(svgPaths.length)]);
                    s[i].attr('stroke', 'none');
                    s[i].translate(paper.width / random(3) - 110, paper.height / 2 - 80);
                    $(s[i]).bind({
                            'animationEnded':
                                function (event) {
                                    var obj = $(event.target).get(0);
                                    if(dieAfter <= obj.attr('transform').length) {
                                        $(document).trigger('SVGRemoved', [i]);
                                        obj.animate(Raphael.animation({
                                            transform: '...r180',
                                            fill: '#000'
                                        }, duration, 'linear', function (){
                                                obj.remove();
                                        }
                                        ));
                                    } else {
                                        obj.animate(getNextAnim());
                                    }
                                },
                            'animationStart':
                                function (event,  delay) {
                                    var obj = $(event.target).get(0);
                                    obj.animate(getNextAnim().delay(delay));
                                }
                            });
                    return $(s[i]);
                }
            });
        </script>
    </head>
    <body>
        <div id="spaceinvader"></div>
        <div id="toolbar">
            <ul>
                <li>Auto: <span id="auto">OFF</span></li>
                <li>Random Timer: <span id="randomTimer"></span></li>
                <li>Speed: <span id="speed"></span>%</li>
                <li>Animation: <span id="animation"></span></li>
                <li id="help">[<b>a</b> toggle auto mode | <b>+&nbsp;-</b> increase/decrease auto timer change | <b>h</b> toggle this toolbar | <b>&darr;</b> decrease speed | <b>&uarr;</b> increase speed | <b>&larr;&rarr;</b> switch animation]</li>
                <li>Fork me on <a href="https://github.com/dB2A/space-invaders">Github</a></li>
            </ul>
        </div>
    </body>
</html>
